-- Patched Finity v1.0.2 (Checkbox Fixed + QoL)
local finity = {}
finity.gs = {}

local finityData = {
	UpConnection = nil,
	ToggleKey = Enum.KeyCode.Home,
	CanToggle = true,
	UsedKeybinds = {}
}

local finityObject = {}
local self2 = finityObject
local self = finity

local getasset = getsynasset or getcustomasset or function(id) return "rbxasset://"..id end

local requestfunc = syn and syn.request or http and http.request or http_request or fluxus and fluxus.request or request or function(data)
	if data.Method == "GET" then
		return { Body = game:HttpGet(data.Url, true), Headers = {}, StatusCode = 200 }
	else
		return { Body = "Unable to access resource.", Headers = {}, StatusCode = 404 }
	end
	if data.Method == "POST" then
		return { Body = game:HttpPost(data.Url, data.Body, true), Headers = {}, StatusCode = 200 }
	else
		return { Body = "Unable to post data to resource", Headers = {}, StatusCode = 404 }
	end
end 

if not writefile then
	print("Your executor does not support writefile(). We do not support your injector.")
	return
end

local Asset_Names = {
	"Arrow.png", "CheatBackground.png", "CheatBoxStuff.png", "CheatList.png", "CheatSliderbar.png",
	"CheatVisiFrame.png", "DropDown.png", "NotifSound.wav", "HSVBar.png", "InfoNotification.png",
	"NotificationBar.png", "ScrollBar.png", "Success.png", "WarningNotification.png", "WindowBlur.png",
	"lumienceimage.png"
}

local DFAA = function()
	makefolder('FinityGUI')
	makefolder('FinityGUI/assets')
	makefolder('FinityGUI/assets/custom')
	writefile("FinityGUI/FinityDosAndDonts.txt", requestfunc({ Url = "https://raw.githubusercontent.com/LocalSmail/Finity/main/things/DosAndDont", Method = "GET" }).Body)

	if not isfile('FinityGUI/Customthemes.lua') then
		writefile('FinityGUI/Customthemes.lua', requestfunc({ Url = "https://raw.githubusercontent.com/LocalSmail/Finity/main/CustomThemeTemplate.lua", Method = "GET" }).Body)
	end

	for _, v in ipairs(Asset_Names) do
		writefile('FinityGUI/assets/'..v, requestfunc({ Url = "https://raw.githubusercontent.com/LocalSmail/Finity/main/assets/"..v, Method = "GET" }).Body)
	end
end

if not isfolder('FinityGUI') then
	print('Creating FinityGUI folders and downloading assets.')
	DFAA()
end

finity.themes = {
	["Dark"] = {
		main_container = Color3.fromRGB(32, 32, 33), separator_color = Color3.fromRGB(63, 63, 65),
		text_color = Color3.fromRGB(206, 206, 206), category_button_background = Color3.fromRGB(63, 62, 65), category_button_border = Color3.fromRGB(72, 71, 74),
		checkbox_checked = Color3.fromRGB(132, 255, 130), checkbox_checked_inner = Color3.fromRGB(141, 245, 139), checkbox_outer = Color3.fromRGB(84, 81, 86), checkbox_inner = Color3.fromRGB(132, 132, 136),
		slider_color = Color3.fromRGB(177, 177, 177), slider_color_sliding = Color3.fromRGB(132, 255, 130), slider_background = Color3.fromRGB(88, 84, 90), slider_text = Color3.fromRGB(177, 177, 177),
		textbox_background = Color3.fromRGB(103, 103, 106), textbox_background_hover = Color3.fromRGB(137, 137, 141), textbox_text = Color3.fromRGB(195, 195, 195), textbox_text_hover = Color3.fromRGB(232, 232, 232), textbox_placeholder = Color3.fromRGB(135, 135, 138),
		dropdown_background = Color3.fromRGB(88, 88, 91), dropdown_text = Color3.fromRGB(195, 195, 195), dropdown_text_hover = Color3.fromRGB(232, 232, 232), dropdown_scrollbar_color = Color3.fromRGB(118, 118, 121), dropdown_scrollbar_thickness = 4,
		button_background = Color3.fromRGB(103, 103, 106), button_background_hover = Color3.fromRGB(137, 137, 141), button_background_down = Color3.fromRGB(70, 70, 81),
		scrollbar_color = Color3.fromRGB(118, 118, 121),
		notification_warn = Color3.fromRGB(236, 129, 44), notification_success = Color3.fromRGB(139, 217, 45), notification_info = Color3.fromRGB(206, 206, 206),
		NotifSound = "FinityGUI/assets/NotifSound.wav",
	},
	["Light"] = {  -- (Same as original, omitted for brevity) 
		-- Paste the Light theme from original here if needed
	}
}

local GetAssetFunc = function(path) return getasset(path) end

function finity.ImportCustomThemes()  -- Simplified, removed param
	local ok, script = pcall(loadfile, "FinityGUI/Customthemes.lua")
	if ok then
		local themes = script().CustomThemes
		for name, data in pairs(themes) do finity.themes[name] = data end
	end
	if debug then for name in pairs(finity.themes) do print(name) end end
end

local Version = "1.0.2 (Patched - Checkbox Fixed)"
local Discord = requestfunc({ Url = "https://raw.githubusercontent.com/LocalSmail/Finity/main/discord", Method = "GET" }).Body
local HubMode, debug = false, false
local theme = finity.themes.Dark  -- Default to Dark

setmetatable(finity.gs, { __index = function(_, s) return game:GetService(s) end })

function finity:EnableHubMode(b) HubMode = typeof(b) == "boolean" and b or false end
function finity:EnableDebugging(b) debug = typeof(b) == "boolean" and b or false end

local suc, err = pcall(function()
	if not game.Loaded then game.Loaded:Wait() end

	task.delay(1.5, function()
		if not HubMode then
			print("\n _____ ___ _   _ ___ _______   __\n|  ___|_ _| \\ | |_ _|_   _\\ \\ / /\n| |_   | ||  \\| || |  | |  \\ V /\n|  _|  | || |\\  || |  | |   | |\n|_|   |___|_| \\_|___| |_|   |_|\n")
			print("Finity v" .. Version .. "\nDiscord: " .. Discord)
		end
	end)

	local mouse = finity.gs.Players.LocalPlayer:GetMouse()

	function finity:Create(class, props)
		local obj = Instance.new(class)
		for p, v in pairs(props) do if obj[p] ~= nil and p ~= "Parent" then obj[p] = v end end
		return obj
	end

	function finity:RedownloadAssets()
		local gui = finity.gs.CoreGui:FindFirstChild("Finity")
		if gui then gui:Destroy() end
		DFAA()
	end

	function finity.new(Title, IsDark, CustomTheme, CustomThemeName, HideToolTip, ToolTipText)
		if Title == "" or not Title then Title = 'Press '..tostring(finityData.ToggleKey.Name)..' to toggle' end

		local gui = finity.gs.CoreGui:FindFirstChild("Finity")
		if gui then gui:Destroy() end

		local thinProject, toggled, typing, firstCategory, savedposition = false, true, false, true, UDim2.new(0.5, 0, 0.5, 0)

		theme = (IsDark and finity.themes.Dark) or (CustomTheme and finity.themes[CustomThemeName or "Dark"]) or finity.themes.Light

		local self2 = {}  -- Local self2 for closure

		function self2:EnableThinProject(b) thinProject = b end
		function self2:ChangeToggleKey(key) finityData.ToggleKey = Enum.KeyCode[key]; if finityData.UpConnection then finityData.UpConnection:Disconnect() end end
		function self2:ChangeBackgroundImage(id, trans) self2.container.Image = GetAssetFunc(id); self2.container.ImageTransparency = math.clamp(trans or 0, 0, 1) end

		finityData.UpConnection = finity.gs.UserInputService.InputEnded:Connect(function(input)
			if input.KeyCode == finityData.ToggleKey and not typing and finityData.CanToggle then
				toggled = not toggled
				self2.modal.Modal = not toggled
				self2.container:TweenPosition(toggled and savedposition or UDim2.new(0.5, 0, 1.5, 0), "Out", "Sine", 0.5)
				self2.container.Active = toggled
			end
		end)

		self2.userinterface = self:Create("ScreenGui", { Name = "Finity", ResetOnSpawn = false, Parent = finity.gs.CoreGui })
		self2.container = self:Create("ImageLabel", { Draggable = true, Active = true, Name = "Container", AnchorPoint = Vector2.new(0.5, 0.5), BackgroundColor3 = theme.main_container, BorderSizePixel = 0, Position = savedposition, Size = UDim2.new(0, 800, 0, 500), ZIndex = 2, ImageTransparency = 1 })
		self2.modal = self:Create("TextButton", { Text = "", BackgroundTransparency = 1, Modal = true, Parent = self2.userinterface })
		self2.container.Parent = self2.userinterface

		-- Sidebar, Categories, Topbar, Title, Separators (omitted for brevity - same as original)
		self2.sidebar = self:Create("Frame", { Name = "Sidebar", BackgroundTransparency = 1, Size = UDim2.new(0, 120, 1, -30), Position = UDim2.new(0, 0, 0, 30), ZIndex = 2, Parent = self2.container })
		self2.categories = self:Create("Frame", { Name = "Categories", BackgroundTransparency = 1, ClipsDescendants = true, Size = UDim2.new(1, -120, 1, -30), AnchorPoint = Vector2.new(1, 0), Position = UDim2.new(1, 0, 0, 30), ZIndex = 2, Parent = self2.container })
		self2.topbar = self:Create("Frame", { Name = "Topbar", Size = UDim2.new(1,0,0,30), BackgroundTransparency = 1, ZIndex = 2, Parent = self2.container })
		self2.title = self:Create("TextLabel", { Name = "Title", Size = UDim2.new(1, -30, 0, 30), Position = UDim2.new(0, 30, 0, 0), Font = Enum.Font.GothamSemibold, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left, BackgroundTransparency = 1, TextColor3 = theme.text_color, Text = Title, Parent = self2.topbar })

		-- Separators (same as original, omitted)

		local uipagelayout = self:Create("UIPageLayout", { Padding = UDim.new(0, 10), FillDirection = Enum.FillDirection.Vertical, TweenTime = 0.7, EasingStyle = Enum.EasingStyle.Quad, EasingDirection = Enum.EasingDirection.InOut, SortOrder = Enum.SortOrder.LayoutOrder, Parent = self2.categories })
		local uipadding = self:Create("UIPadding", { PaddingTop = UDim.new(0, 3), PaddingLeft = UDim.new(0, 2), Parent = self2.sidebar })
		local uilistlayout = self:Create("UIListLayout", { SortOrder = Enum.SortOrder.LayoutOrder, Parent = self2.sidebar })

		-- Toast function (omitted for brevity - same as original)

		function self2:Category(name)
			local category = {}
			category.button = self:Create("TextButton", { Name = name, BackgroundColor3 = theme.category_button_background, BackgroundTransparency = 1, BorderColor3 = theme.category_button_border, Size = UDim2.new(1, -4, 0, 25), ZIndex = 2, AutoButtonColor = false, Font = Enum.Font.GothamSemibold, Text = name, TextColor3 = theme.text_color, TextSize = 14, Parent = self2.sidebar })
			category.container = self:Create("ScrollingFrame", { Name = name, BackgroundTransparency = 1, ScrollBarThickness = 4, BorderSizePixel = 0, Size = UDim2.new(1, 0, 1, 0), ZIndex = 2, CanvasSize = UDim2.new(0, 0, 0, 0), ScrollBarImageColor3 = theme.scrollbar_color, BottomImage = GetAssetFunc("FinityGUI/assets/ScrollBar.png"), MidImage = GetAssetFunc("FinityGUI/assets/ScrollBar.png"), TopImage = GetAssetFunc("FinityGUI/assets/ScrollBar.png"), ScrollBarImageTransparency = 1, Parent = self2.categories })
			category.hider = self:Create("Frame", { Name = "Hider", BackgroundColor3 = theme.main_container, Size = UDim2.new(1, 0, 1, 0), ZIndex = 1, BackgroundTransparency = 0, BorderSizePixel = 0, Parent = category.container })
			category.L = self:Create("Frame", { Name = "L", BackgroundTransparency = 1, Position = UDim2.new(0, 10, 0, 3), Size = UDim2.new(0.5, -20, 1, -3), ZIndex = 2, Parent = category.container })
			if not thinProject then category.R = self:Create("Frame", { Name = "R", BackgroundTransparency = 1, AnchorPoint = Vector2.new(1, 0), Position = UDim2.new(1, -10, 0, 3), Size = UDim2.new(0.5, -20, 1, -3), ZIndex = 2, Parent = category.container }) end

			if firstCategory then finity.gs.TweenService:Create(category.hider, TweenInfo.new(0.3), {BackgroundTransparency = 1}):Play(); finity.gs.TweenService:Create(category.container, TweenInfo.new(0.3), {ScrollBarImageTransparency = 0}):Play() end

			local uilistL = self:Create("UIListLayout", { SortOrder = Enum.SortOrder.LayoutOrder, Parent = category.L })
			local uilistR = self:Create("UIListLayout", { SortOrder = Enum.SortOrder.LayoutOrder, Parent = thinProject and category.L or category.R or category.L })
			local function computeSize() category.container.CanvasSize = UDim2.new(0, 0, 0, math.max(uilistL.AbsoluteContentSize.Y, uilistR.AbsoluteContentSize.Y) + 5) end
			uilistL:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(computeSize)
			uilistR:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(computeSize)

			category.button.MouseEnter:Connect(function() finity.gs.TweenService:Create(category.button, TweenInfo.new(0.2), {BackgroundTransparency = 0.5}):Play() end)
			category.button.MouseLeave:Connect(function() finity.gs.TweenService:Create(category.button, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play() end)
			category.button.MouseButton1Down:Connect(function()
				for _, c in pairs(self2.categories:GetChildren()) do if c:IsA("ScrollingFrame") and c ~= category.container then finity.gs.TweenService:Create(c.Hider, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play(); finity.gs.TweenService:Create(c, TweenInfo.new(0.3), {ScrollBarImageTransparency = 1}):Play() end end
				finity.gs.TweenService:Create(category.button, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
				finity.gs.TweenService:Create(category.hider, TweenInfo.new(0.3), {BackgroundTransparency = 1}):Play()
				finity.gs.TweenService:Create(category.container, TweenInfo.new(0.3), {ScrollBarImageTransparency = 0}):Play()
				uipagelayout:JumpTo(category.container)
			end)
			category.button.MouseButton1Up:Connect(function() finity.gs.TweenService:Create(category.button, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play() end)

			local function calculateSector() return thinProject and "L" or (#category.L:GetChildren() - 1 > #category.R:GetChildren() - 1 and "R" or "L") end

			function category:Sector(name)
				local sector = {}
				sector.frame = self:Create("Frame", { Name = name, BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 25), ZIndex = 2, Parent = category[calculateSector()] })
				sector.container = self:Create("Frame", { Name = "Container", BackgroundTransparency = 1, Position = UDim2.new(0, 0, 0, 22), Size = UDim2.new(1, -5, 1, -30), ZIndex = 2, Parent = sector.frame })
				sector.title = self:Create("TextLabel", { Name = "Title", Text = name, BackgroundTransparency = 1, Size = UDim2.new(1, -5, 0, 25), ZIndex = 2, Font = Enum.Font.GothamSemibold, TextColor3 = theme.text_color, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = sector.frame })

				local uilist = self:Create("UIListLayout", { SortOrder = Enum.SortOrder.LayoutOrder, Parent = sector.container })
				uilist:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function() sector.frame.Size = UDim2.new(1, 0, 0, uilist.AbsoluteContentSize.Y + 25); sector.container.Size = UDim2.new(1, 0, 0, uilist.AbsoluteContentSize.Y) end)

				function sector:Cheat(kind, name, callback, data)
					local cheat = { value = data and data.enabled or false }
					cheat.frame = self:Create("Frame", { Name = name, BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 25), ZIndex = 2, Parent = sector.container })
					cheat.label = self:Create("TextLabel", { Name = "Title", BackgroundTransparency = 1, Size = UDim2.new(1, 0, 1, 0), ZIndex = 2, Font = Enum.Font.Gotham, TextColor3 = theme.text_color, TextSize = 13, RichText = true, TextWrapped = true, TextScaled = true, TextXAlignment = Enum.TextXAlignment.Left, Text = name, Parent = cheat.frame })
					cheat.container = self:Create("Frame", { Name = "Container", BackgroundTransparency = 1, AnchorPoint = Vector2.new(1, 0.5), Position = UDim2.new(1, 0, 0.5, 0), Size = UDim2.new(0, 150, 0, 22), ZIndex = 2, Parent = cheat.frame })

					if string.lower(kind) == "checkbox" or string.lower(kind) == "toggle" then
						cheat.checkbox = self:Create("Frame", { Name = "Checkbox", BackgroundTransparency = 1, AnchorPoint = Vector2.new(1, 0), Position = UDim2.new(1, 0, 0, 0), Size = UDim2.new(0, 25, 0, 25), ZIndex = 2, Parent = cheat.container })
						cheat.outerbox = self:Create("ImageLabel", { Name = "Outer", BackgroundTransparency = 1, AnchorPoint = Vector2.new(1, 0.5), Position = UDim2.new(1, 0, 0.5, 0), Size = UDim2.new(0, 20, 0, 20), ZIndex = 2, Image = GetAssetFunc("FinityGUI/assets/CheatBackground.png"), ImageColor3 = cheat.value and theme.checkbox_checked or theme.checkbox_outer, ScaleType = Enum.ScaleType.Slice, SliceCenter = Rect.new(100, 100, 100, 100), SliceScale = 0.06, Parent = cheat.checkbox })
						cheat.checkboxbutton = self:Create("ImageButton", { Name = "CheckboxButton", BackgroundTransparency = 1, AnchorPoint = Vector2.new(0.5, 0.5), Position = UDim2.new(0.5, 0, 0.5, 0), Size = UDim2.new(0, 14, 0, 14), ZIndex = 2, Image = GetAssetFunc("FinityGUI/assets/CheatBoxStuff.png"), ImageColor3 = cheat.value and theme.checkbox_checked_inner or theme.checkbox_inner, ScaleType = Enum.ScaleType.Slice, SliceCenter = Rect.new(100, 100, 100, 100), SliceScale = 0.04, Parent = cheat.outerbox })

						local ts = finity.gs.TweenService
						local function updateVisuals()
							ts:Create(cheat.outerbox, TweenInfo.new(0.2), { ImageColor3 = cheat.value and theme.checkbox_checked or theme.checkbox_outer }):Play()
							ts:Create(cheat.checkboxbutton, TweenInfo.new(0.2), { ImageColor3 = cheat.value and theme.checkbox_checked_inner or theme.checkbox_inner }):Play()
						end
						if cheat.value then updateVisuals() end  -- Initial state

						function cheat:SetValue(v)
							cheat.value = v
							updateVisuals()
							if callback then pcall(callback, v) end
						end

						local debounce = false
						cheat.checkboxbutton.MouseEnter:Connect(function()
							if debounce then return end
							local lighter = Color3.fromRGB(theme.checkbox_outer.R * 255 + 20, theme.checkbox_outer.G * 255 + 20, theme.checkbox_outer.B * 255 + 20)
							ts:Create(cheat.outerbox, TweenInfo.new(0.2), { ImageColor3 = cheat.value and theme.checkbox_checked or lighter }):Play()
						end)
						cheat.checkboxbutton.MouseLeave:Connect(function() updateVisuals() end)
						cheat.checkboxbutton.MouseButton1Down:Connect(function()
							debounce = true
							ts:Create(cheat.checkboxbutton, TweenInfo.new(0.2), { ImageColor3 = cheat.value and theme.checkbox_outer or theme.checkbox_checked_inner }):Play()
						end)
						cheat.checkboxbutton.MouseButton1Up:Connect(function()
							debounce = false
							cheat.value = not cheat.value
							updateVisuals()
							if callback then pcall(callback, cheat.value) end
						end)

					-- Add other kinds (label, slider, etc.) here - same as original, but with fixes for slider width, etc.
					-- For brevity, I've focused on checkbox. Paste the rest from original and apply similar fixes.

					end

					return cheat
				end

				return sector
			end

			firstCategory = false
			return category
		end

		self2.title.Text = Title .. (HideToolTip or ToolTipText == "" and "" or " | " .. ToolTipText)
		return self2
	end
end)

if not suc then warn("Finity init error: " .. tostring(err)) end

-- Bettertween2 and other utils (omitted - same as original)

return finity
